Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-runtime-ubuntu22.04

%environment

export PATH=/opt/miniforge3/bin:$PATH
export LD_LIBRARY_PATH=/opt/miniforge3/lib:$LD_LIBRARY_PATH
export CONDA_PLUGINS_AUTO_ACCEPT_TOS="yes"
export PYTHONNOUSERSITE=True
export ALPHAFOLD_PREFIX=/app/alphafold

%post 

apt-get update 
DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
build-essential \
cmake \
cuda-command-line-tools-12-2 \
git \
hmmer \
kalign \
tzdata \
wget \
aria2 \
nano \
curl
rm -rf /var/lib/apt/lists/* 
apt-get autoremove -y 
apt-get clean

# Compile HHsuite from source.
rm -rf /tmp/hh-suite
git clone --branch v3.3.0 https://github.com/soedinglab/hh-suite.git /tmp/hh-suite 
mkdir -p /tmp/hh-suite/build 
cd /tmp/hh-suite/build
cmake -DCMAKE_INSTALL_PREFIX=/opt/hhsuite .. 
make -j 4 && make install 
ln -s /opt/hhsuite/bin/* /usr/bin
cd /tmp
rm -rf /tmp/hh-suite

# Install Miniforge3
cd /tmp
curl -L -O "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
bash Miniforge3-$(uname)-$(uname -m).sh -fp /opt/miniforge3 -b
rm Miniforge3*sh

export PATH=/opt/miniforge3/bin:$PATH

# Install conda packages.
mamba install --yes --quiet pip python=3.11 \
    && mamba install --yes --quiet -c nvidia cuda=${CUDA_VERSION} \
    && mamba install --yes --quiet -c conda-forge openmm=8.0.0 pdbfixer \
    && mamba clean --all --force-pkgs-dirs --yes

# Download AF 40be3ec
ALPHAFOLD_DIR=/app/alphafold
git clone https://github.com/deepmind/alphafold $ALPHAFOLD_DIR
cd $ALPHAFOLD_DIR
git checkout 40be3ec

# jax 0.4.26 does not have scipy.special.softmax
# To fix this:
sed -i 's/from jax\.scipy import special/from scipy import special/' \
    /app/alphafold/alphafold/common/confidence.py

# Apply AF patch
git clone https://gitlab.liu.se/xuagu37/berzelius-alphafold-guide /tmp/berzelius-alphafold-guide
cd /tmp
bash berzelius-alphafold-guide/patch/patch_40be3ec/patch_40be3ec.sh ${ALPHAFOLD_DIR} 
rm -rf /tmp/berzelius-alphafold-guide

wget -q -P /app/alphafold/alphafold/common/ https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt

# Install pip packages.
pip3 install --upgrade pip --no-cache-dir 
pip3 install -r /app/alphafold/requirements.txt --no-cache-dir 
pip3 install --upgrade --no-cache-dir mock==5.0.1 \
jax==0.4.26 \
jaxlib==0.4.26+cuda12.cudnn89 \
-f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

# Currently needed to avoid undefined_symbol error.
ln -sf /usr/lib/x86_64-linux-gnu/libffi.so.7 /opt/miniforge3/lib/libffi.so.7
