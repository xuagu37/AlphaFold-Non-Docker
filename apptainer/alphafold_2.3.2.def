Bootstrap: docker
From: nvidia/cuda:11.1.1-cudnn8-runtime-ubuntu18.04

%environment

export PATH=/opt/miniforge3/bin:$PATH
export PYTHONNOUSERSITE=True
export ALPHAFOLD_PREFIX=/app/alphafold

%post 

apt-get update 
DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
build-essential \
cmake \
cuda-command-line-tools-11-1 \
git \
hmmer \
kalign \
tzdata \
wget \
aria2 \
nano \
curl
rm -rf /var/lib/apt/lists/* 
apt-get autoremove -y 
apt-get clean

# Compile HHsuite from source.
rm -rf /tmp/hh-suite
git clone --branch v3.3.0 https://github.com/soedinglab/hh-suite.git /tmp/hh-suite 
mkdir -p /tmp/hh-suite/build 
cd /tmp/hh-suite/build
cmake -DCMAKE_INSTALL_PREFIX=/opt/hhsuite .. 
make -j 4 && make install 
ln -s /opt/hhsuite/bin/* /usr/bin
cd /tmp
rm -rf /tmp/hh-suite

# Install Miniforge3
cd /tmp
curl -L -O "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
bash Miniforge3-$(uname)-$(uname -m).sh -fp /opt/miniforge3 -b
rm Miniforge3*sh

export PATH=/opt/miniforge3/bin:$PATH

# Install conda packages.
mamba install -y -c conda-forge openmm=7.5.1 \
cudatoolkit==11.1.1 \
pdbfixer \
pip \
python=3.8 
mamba clean --all --force-pkgs-dirs --yes

# Download AF 2.3.2
ALPHAFOLD_DIR=/app/alphafold 
mkdir -p ${ALPHAFOLD_DIR} 
wget -O /tmp/v2.3.2.tar.gz https://github.com/deepmind/alphafold/archive/refs/tags/v2.3.2.tar.gz
tar -xf /tmp/v2.3.2.tar.gz -C ${ALPHAFOLD_DIR} --strip-components=1

# Apply AF patch
rm -rf /tmp/berzelius-alphafold-guide
git clone https://gitlab.liu.se/xuagu37/berzelius-alphafold-guide /tmp/berzelius-alphafold-guide
cd /tmp
bash berzelius-alphafold-guide/patch/patch_2.3.2/patch_2.3.2.sh ${ALPHAFOLD_DIR} 

wget -q -P /app/alphafold/alphafold/common/ https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt

# Install pip packages.
pip3 install --upgrade pip --no-cache-dir 
pip3 install -r /app/alphafold/requirements.txt --no-cache-dir 
pip3 install --upgrade --no-cache-dir mock==5.0.1 \
jax==0.3.25 \
jaxlib==0.3.25+cuda11.cudnn805 \
-f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

# Apply OpenMM patch.
cd /opt/miniforge3/lib/python3.8/site-packages
patch -p0 < /app/alphafold/docker/openmm.patch